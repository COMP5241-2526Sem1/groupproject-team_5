{% extends "base.html" %}

{% block title %}Create Activity - {{ course.name }}{% endblock %}

{% block content %}
<style>
/* 优化的创建活动页面样式 */
.create-activity-container {
    background: linear-gradient(135deg, #f0f9ff 0%, #e3f2fd 50%, #bbdefb 100%);
    min-height: calc(100vh - 100px);
    padding: 40px 0;
}

.create-activity-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(33, 150, 243, 0.15);
    border: none;
    overflow: hidden;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

.create-activity-card:hover {
    box-shadow: 0 15px 50px rgba(33, 150, 243, 0.25);
}

/* 页面标题区优化 */
.page-header-activity {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    padding: 30px;
    margin: -40px -40px 30px -40px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.page-header-activity::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: rotate 20s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.page-header-activity .icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    margin-bottom: 15px;
    position: relative;
    z-index: 1;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.page-header-activity .icon-wrapper i {
    font-size: 2.5rem;
    color: white;
}

.page-header-activity h3 {
    color: white;
    font-weight: 700;
    margin: 0;
    position: relative;
    z-index: 1;
}

.page-header-activity p {
    color: rgba(255, 255, 255, 0.9);
    margin: 10px 0 0 0;
    position: relative;
    z-index: 1;
}

/* 表单标签优化 */
.form-label {
    font-weight: 600;
    color: #153d5a;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-label::before {
    content: '✦';
    color: #00bcd4;
    font-size: 0.8rem;
}

/* 表单输入框优化 */
.form-control, .form-select {
    border: 2px solid rgba(0, 188, 212, 0.15);
    border-radius: 12px;
    padding: 12px 18px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
}

.form-control:focus, .form-select:focus {
    border-color: #00bcd4;
    box-shadow: 0 0 0 0.3rem rgba(0, 188, 212, 0.15), 0 4px 12px rgba(0, 188, 212, 0.1);
    transform: translateY(-2px);
    background: white;
}

.form-control::placeholder {
    color: #a0b9d0;
    font-style: italic;
}

/* 选项行样式优化 */
.option-row {
    background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 8px;
    transition: all 0.25s ease;
}

.option-row:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    transform: translateX(4px);
}

.option-label {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    color: white;
    font-weight: 700;
    border-radius: 8px;
    min-width: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-option {
    border-radius: 8px;
}

/* 按钮优化 */
.btn-primary-create {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    border: none;
    padding: 14px 32px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    color: white;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
    position: relative;
    overflow: hidden;
}

.btn-primary-create::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-primary-create:hover::before {
    width: 400px;
    height: 400px;
}

.btn-primary-create:hover {
    background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 188, 212, 0.4);
}

.btn-cancel {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    border: none;
    padding: 14px 32px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    color: #424242;
    transition: all 0.3s ease;
}

.btn-cancel:hover {
    background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* AI卡片优化 */
.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid rgba(0, 188, 212, 0.1);
    padding: 18px 24px;
    font-weight: 700;
    color: #153d5a;
}

.card-header h5 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-header i {
    color: #00bcd4;
    font-size: 1.3rem;
}

/* Tab导航优化 */
.nav-tabs {
    border-bottom: 2px solid rgba(0, 188, 212, 0.1);
}

.nav-tabs .nav-link {
    border: none;
    border-radius: 10px 10px 0 0;
    color: #6c757d;
    font-weight: 600;
    padding: 12px 24px;
    transition: all 0.3s ease;
    margin-right: 8px;
}

.nav-tabs .nav-link:hover {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
    color: #00838f;
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3);
}

/* Duration输入组优化 */
.input-group {
    background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 188, 212, 0.1);
}

.input-group .form-control {
    border: none;
    background: transparent;
}

.input-group .btn {
    border: none;
    background: rgba(0, 188, 212, 0.1);
    color: #00838f;
    font-weight: 600;
    transition: all 0.25s ease;
}

.input-group .btn:hover {
    background: rgba(0, 188, 212, 0.2);
}

/* 小按钮优化 */
.btn-sm {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.25s ease;
}

.btn-outline-primary {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border: none;
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    transform: translateY(-2px);
}

/* Generated questions样式 */
#generated-questions .card {
    border-radius: 12px;
    border: 2px solid rgba(0, 188, 212, 0.1);
    transition: all 0.25s ease;
}

#generated-questions .card:hover {
    border-color: rgba(0, 188, 212, 0.3);
    box-shadow: 0 4px 12px rgba(0, 188, 212, 0.15);
    transform: translateX(4px);
}
</style>

<div class="create-activity-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card create-activity-card">
                    <div class="card-body p-4 p-md-5">
                        <div class="page-header-activity">
                            <div class="icon-wrapper">
                                <i class="bi bi-plus-circle"></i>
                            </div>
                            <h3>Create Activity in {{ course.name }}</h3>
                            <p>Define the activity details and optional AI-assisted generation below.</p>
                        </div>

                    <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control") }}
                        {% if form.title.errors %}
                            <div class="text-danger">
                                {% for error in form.title.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.type.label(class="form-label") }}
                        {{ form.type(class="form-select") }}
                        {% if form.type.errors %}
                            <div class="text-danger">
                                {% for error in form.type.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="quiz-fields" style="display: none;">
                        <label class="form-label">Quiz Type</label>
                        <select id="quiz-type" class="form-select" name="quiz_type">
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="fill_blank">Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.question.label(class="form-label") }}
                        {{ form.question(class="form-control", rows="4") }}
                        {% if form.question.errors %}
                            <div class="text-danger">
                                {% for error in form.question.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="options-field" style="display: none;">
                        <label class="form-label">Options</label>
                        {{ form.options(id="options-hidden") }}
                        <div id="options-list" class="d-flex flex-column gap-2"></div>
                        <button type="button" id="add-option" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="bi bi-plus"></i> Add option
                        </button>
                        <div class="form-text">Enter one option per line. At least two options are required.</div>
                        {% if form.options.errors %}
                            <div class="text-danger">
                                {% for error in form.options.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="correct-answer-field" style="display: none;">
                        <label class="form-label">Correct Answer</label>
                        <select id="correct-answer-select" class="form-select" style="display: none;"></select>
                        <input type="text" id="correct-answer-text" class="form-control" style="display: none;" placeholder="Enter correct answer">
                        <input type="hidden" id="correct-answer-hidden" name="correct_answer">
                        <div class="form-text" id="correct-answer-hint"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity Duration</label>
                        <div class="row g-2">
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" id="duration-hours" class="form-control" value="0" aria-label="Hours">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Hours
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-hours-menu">
                                        {% for i in range(0, 13) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="hours" data-value="{{ i }}">{{ i }} hour{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" max="59" id="duration-minutes" class="form-control" value="5" aria-label="Minutes">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Minutes
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-minutes-menu">
                                        {% for i in range(0, 60) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="minutes" data-value="{{ i }}">{{ i }} min{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" max="59" id="duration-seconds" class="form-control" value="0" aria-label="Seconds">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Seconds
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-seconds-menu">
                                        {% for i in range(0, 60) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="seconds" data-value="{{ i }}">{{ i }} sec{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="duration-hidden" name="duration_seconds" value="300">
                        <div class="form-text mt-2">Specify how long the activity remains open. Set hours, minutes, and seconds, or choose from the dropdown menus.</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-primary-create btn-lg") }}
                        <a href="{{ url_for('courses.course_detail', course_id=course.id) }}" class="btn btn-cancel">Cancel</a>
                    </div>
                </form>
                </div>
            </div>

            <div class="card create-activity-card mt-3 mb-5">
            <div class="card-header">
                <h5><i class="bi bi-robot"></i> AI-Assisted Question Generation</h5>
            </div>
            <div class="card-body">
                <!-- Tab navigation -->
                <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-panel" type="button" role="tab">
                            <i class="bi bi-file-text"></i> Text Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-panel" type="button" role="tab">
                            <i class="bi bi-file-earmark-arrow-up"></i> File Upload
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content mt-3" id="aiTabContent">
                    <!-- Text input tab -->
                    <div class="tab-pane fade show active" id="text-panel" role="tabpanel">
                <div class="mb-3">
                    <label for="ai-text" class="form-label">Paste Teaching Text</label>
                    <textarea id="ai-text" class="form-control" rows="4" placeholder="Paste your teaching text here, and AI will generate related questions..."></textarea>
                </div>
                        <button id="generate-questions-text" class="btn btn-outline-primary">
                    <i class="bi bi-robot"></i> Generate Questions
                </button>
                    </div>
                    
                    <!-- File upload tab -->
                    <div class="tab-pane fade" id="file-panel" role="tabpanel">
                        <div class="mb-3">
                            <label for="ai-file" class="form-label">Upload Document</label>
                            <div class="custom-file-upload">
                                <input type="file" id="ai-file" class="d-none" accept=".pdf,.docx,.pptx" />
                                <button type="button" class="btn btn-outline-secondary" id="file-upload-btn">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Choose File
                                </button>
                                <span id="file-upload-status" class="ms-2 text-muted">No file selected</span>
                            </div>
                            <div class="form-text mt-2">
                                <i class="bi bi-info-circle"></i> Supported formats: PDF (.pdf), Word Document (.docx), PowerPoint (.pptx). Maximum size: 10MB
                            </div>
                        </div>
                        <button id="generate-questions-file" class="btn btn-outline-primary">
                            <i class="bi bi-robot"></i> Generate Questions from File
                        </button>
                    </div>
                </div>
                
                <div id="generated-questions" class="mt-3" style="display: none;">
                    <h6>Generated Questions:</h6>
                    <div id="questions-list"></div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formEl = document.querySelector('form');
    const typeSelect = document.getElementById('type');
    const optionsField = document.getElementById('options-field');
    const optionsHidden = document.getElementById('options-hidden');
    const optionsList = document.getElementById('options-list');
    const addOptionBtn = document.getElementById('add-option');
    const quizFields = document.getElementById('quiz-fields');
    const quizTypeSelect = document.getElementById('quiz-type');
    const correctAnswerField = document.getElementById('correct-answer-field');
    const correctAnswerSelect = document.getElementById('correct-answer-select');
    const correctAnswerText = document.getElementById('correct-answer-text');
    const correctAnswerHidden = document.getElementById('correct-answer-hidden');
    const correctAnswerHint = document.getElementById('correct-answer-hint');
    const durationHidden = document.getElementById('duration-hidden');
    const durationHoursInput = document.getElementById('duration-hours');
    const durationMinutesInput = document.getElementById('duration-minutes');
    const durationSecondsInput = document.getElementById('duration-seconds');
    const generateTextBtn = document.getElementById('generate-questions-text');
    const generateFileBtn = document.getElementById('generate-questions-file');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const fileInput = document.getElementById('ai-file');
    const fileStatus = document.getElementById('file-upload-status');

    function createOptionRow(value = '') {
        const row = document.createElement('div');
        row.className = 'input-group option-row';

        const label = document.createElement('span');
        label.className = 'input-group-text option-label';
        row.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control option-input';
        input.placeholder = 'Enter option';
        input.value = value;
        row.appendChild(input);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-outline-danger remove-option';
        removeBtn.innerHTML = '<i class="bi bi-dash"></i>';
        row.appendChild(removeBtn);

        removeBtn.addEventListener('click', function() {
            const rows = optionsList.querySelectorAll('.option-row');
            if (rows.length <= 1) {
                input.value = '';
                return;
            }
            row.remove();
            refreshOptionLabels();
            syncCorrectAnswerOptions();
        });

        input.addEventListener('input', syncCorrectAnswerOptions);
        return row;
    }

    function refreshOptionLabels() {
        const rows = optionsList.querySelectorAll('.option-row');
        rows.forEach((row, index) => {
            const label = row.querySelector('.option-label');
            label.textContent = String.fromCharCode(65 + index);
        });
    }

    function ensureOptionRows(min = 1) {
        let rows = optionsList.querySelectorAll('.option-row').length;
        while (rows < min) {
            optionsList.appendChild(createOptionRow());
            rows++;
        }
        refreshOptionLabels();
        syncCorrectAnswerOptions();
    }

    function getCurrentOptions() {
        const values = [];
        optionsList.querySelectorAll('.option-input').forEach(input => {
            const val = input.value.trim();
            if (val) {
                values.push(val);
            }
        });
        return values;
    }

    function showOptionsField(show) {
        optionsField.style.display = show ? 'block' : 'none';
    }

    function showCorrectAnswerSelect(show) {
        correctAnswerField.style.display = show ? 'block' : 'none';
        correctAnswerSelect.style.display = show ? 'block' : 'none';
        correctAnswerText.style.display = 'none';
        correctAnswerHint.textContent = show ? 'Select the correct answer from the options above.' : '';
    }

    function showCorrectAnswerText(show, placeholder = 'Enter correct answer') {
        correctAnswerField.style.display = show ? 'block' : 'none';
        correctAnswerSelect.style.display = 'none';
        correctAnswerText.style.display = show ? 'block' : 'none';
        correctAnswerText.placeholder = placeholder;
        correctAnswerHint.textContent = show ? 'Type the exact correct answer.' : '';
    }

    function syncCorrectAnswerOptions() {
        if (typeSelect.value !== 'quiz') {
            return;
        }
        const quizType = quizTypeSelect.value;
        if (quizType === 'multiple_choice') {
            const options = getCurrentOptions();
            correctAnswerSelect.innerHTML = '<option value="">Select correct answer</option>';
            options.forEach(option => {
                const optEl = document.createElement('option');
                optEl.value = option;
                optEl.textContent = option;
                correctAnswerSelect.appendChild(optEl);
            });
            if (options.includes(correctAnswerHidden.value)) {
                correctAnswerSelect.value = correctAnswerHidden.value;
            } else {
                correctAnswerSelect.value = '';
                correctAnswerHidden.value = '';
            }
        } else if (quizType === 'true_false') {
            correctAnswerSelect.innerHTML = '<option value="True">True</option><option value="False">False</option>';
            if (['True', 'False'].includes(correctAnswerHidden.value)) {
                correctAnswerSelect.value = correctAnswerHidden.value;
            } else {
                correctAnswerSelect.value = 'True';
                correctAnswerHidden.value = 'True';
            }
        }
    }

    function clampInputValue(input, min, max) {
        let value = parseInt(input.value, 10);
        if (isNaN(value) || value < min) {
            value = min;
        }
        if (typeof max === 'number' && value > max) {
            value = max;
        }
        input.value = value;
    }

    function initializeDurationFields() {
        if (!durationHidden) {
            return;
        }
        let storedMinutes = parseInt(durationHidden.value, 10);
        if (isNaN(storedMinutes) || storedMinutes < 1) {
            storedMinutes = 5;
        }
        const totalSeconds = storedMinutes * 60;
        if (durationHoursInput) {
            durationHoursInput.value = Math.floor(totalSeconds / 3600);
        }
        if (durationMinutesInput) {
            durationMinutesInput.value = Math.floor((totalSeconds % 3600) / 60);
        }
        if (durationSecondsInput) {
            durationSecondsInput.value = totalSeconds % 60;
        }
    }

    function handleTypeChange() {
        const type = typeSelect.value;
        if (type === 'poll') {
            quizFields.style.display = 'none';
            showOptionsField(true);
            showCorrectAnswerSelect(false);
            ensureOptionRows(1);
        } else if (type === 'quiz') {
            quizFields.style.display = 'block';
            handleQuizTypeChange();
        } else {
    quizFields.style.display = 'none';
            showOptionsField(false);
            showCorrectAnswerSelect(false);
        }
    }

    function handleQuizTypeChange() {
        const quizType = quizTypeSelect.value;
        if (quizType === 'multiple_choice') {
            showOptionsField(true);
            ensureOptionRows(1);
            showCorrectAnswerSelect(true);
            syncCorrectAnswerOptions();
        } else if (quizType === 'true_false') {
            showOptionsField(false);
            showCorrectAnswerSelect(true);
            syncCorrectAnswerOptions();
        } else {
            showOptionsField(false);
            showCorrectAnswerText(true, 'Enter the correct answer');
        }
    }

    if (addOptionBtn) {
        addOptionBtn.addEventListener('click', function() {
            optionsList.appendChild(createOptionRow());
            refreshOptionLabels();
            syncCorrectAnswerOptions();
        });
    }

    if (correctAnswerSelect) {
        correctAnswerSelect.addEventListener('change', function() {
            correctAnswerHidden.value = this.value;
        });
    }

    if (correctAnswerText) {
        correctAnswerText.addEventListener('input', function() {
            correctAnswerHidden.value = this.value.trim();
        });
    }

    if (formEl) {
        formEl.addEventListener('submit', function(event) {
            
            // Set duration value before validation
            if (durationHidden && durationHoursInput && durationMinutesInput && durationSecondsInput) {
                clampInputValue(durationHoursInput, 0, null);
                clampInputValue(durationMinutesInput, 0, 59);
                clampInputValue(durationSecondsInput, 0, 59);
                const hours = parseInt(durationHoursInput.value, 10) || 0;
                const minutesPart = parseInt(durationMinutesInput.value, 10) || 0;
                const secondsPart = parseInt(durationSecondsInput.value, 10) || 0;
                const totalSeconds = hours * 3600 + minutesPart * 60 + secondsPart;
                
                // Set the hidden field value (total seconds)
                durationHidden.value = totalSeconds;
                durationHidden.setAttribute('value', totalSeconds);
                
                // Validate duration
                if (totalSeconds <= 0) {
                    event.preventDefault();
                    alert('Please set a duration greater than zero.');
                    return;
                }
            }

            const type = typeSelect.value;
            const quizType = quizTypeSelect.value;
            let options = [];

            if (optionsField.style.display !== 'none') {
                options = getCurrentOptions();
                if (options.length < 2) {
                    event.preventDefault();
                    alert('Please enter at least two options.');
                    return;
                }
                optionsHidden.value = options.join('\n');
            } else {
                optionsHidden.value = '';
            }

            if (type === 'quiz') {
                if (quizType === 'multiple_choice') {
                    if (!correctAnswerSelect.value) {
                        event.preventDefault();
                        alert('Please select the correct answer.');
                        return;
                    }
                    correctAnswerHidden.value = correctAnswerSelect.value;
                } else if (quizType === 'true_false') {
                    correctAnswerHidden.value = correctAnswerSelect.value || 'True';
                } else {
                    const val = correctAnswerText.value.trim();
                    if (!val) {
                        event.preventDefault();
                        alert('Please enter the correct answer.');
                        return;
                    }
                    correctAnswerHidden.value = val;
                }
            } else {
                correctAnswerHidden.value = '';
            }
        });
    }

    const initialOptions = optionsHidden.value
        ? optionsHidden.value.split('\n').map(opt => opt.trim()).filter(opt => opt)
        : [];
    if (initialOptions.length) {
        initialOptions.forEach(opt => optionsList.appendChild(createOptionRow(opt)));
    } else {
        ensureOptionRows(1);
    }
    refreshOptionLabels();
    syncCorrectAnswerOptions();

    if (typeSelect) {
        handleTypeChange();
        typeSelect.addEventListener('change', handleTypeChange);
    }
    if (quizTypeSelect) {
        quizTypeSelect.addEventListener('change', handleQuizTypeChange);
    }

    if (durationHoursInput) {
        durationHoursInput.addEventListener('input', function() {
            clampInputValue(durationHoursInput, 0, null);
        });
    }
    if (durationMinutesInput) {
        durationMinutesInput.addEventListener('input', function() {
            clampInputValue(durationMinutesInput, 0, 59);
        });
    }
    if (durationSecondsInput) {
        durationSecondsInput.addEventListener('input', function() {
            clampInputValue(durationSecondsInput, 0, 59);
        });
    }

    document.querySelectorAll('.duration-select-option').forEach(item => {
        item.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            const value = parseInt(this.getAttribute('data-value'), 10) || 0;
            
            if (target === 'hours' && durationHoursInput) {
                durationHoursInput.value = value;
            } else if (target === 'minutes' && durationMinutesInput) {
                durationMinutesInput.value = value;
            } else if (target === 'seconds' && durationSecondsInput) {
                durationSecondsInput.value = value;
            }
        });
    });

    initializeDurationFields();

    if (generateTextBtn) {
        generateTextBtn.addEventListener('click', function() {
            const textArea = document.getElementById('ai-text');
            const text = textArea ? textArea.value.trim() : '';
    if (!text) {
        alert('Please enter teaching text');
        return;
    }
            generateQuestionsFromText(text, this);
        });
    }

    if (generateFileBtn) {
        generateFileBtn.addEventListener('click', function() {
            const file = fileInput ? fileInput.files[0] : null;
            if (!file) {
                alert('Please select a file');
                return;
            }
            const allowedTypes = ['.pdf', '.docx', '.pptx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension)) {
                alert('Please upload a PDF, Word document, or PowerPoint presentation');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }
            generateQuestionsFromFile(file, this);
        });
    }

    if (fileUploadBtn && fileInput && fileStatus) {
        fileUploadBtn.addEventListener('click', function() {
            fileInput.click();
        });
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                const displayName = fileName.length > 30 ? fileName.substring(0, 27) + '...' : fileName;
                fileStatus.textContent = displayName;
                fileStatus.classList.remove('text-muted');
                fileStatus.classList.add('text-success');
                fileUploadBtn.classList.remove('btn-outline-secondary');
                fileUploadBtn.classList.add('btn-outline-success');
                fileUploadBtn.innerHTML = '<i class="bi bi-file-earmark-check"></i> File Selected';
            } else {
                fileStatus.textContent = 'No file selected';
                fileStatus.classList.remove('text-success');
                fileStatus.classList.add('text-muted');
                fileUploadBtn.classList.remove('btn-outline-success');
                fileUploadBtn.classList.add('btn-outline-secondary');
                fileUploadBtn.innerHTML = '<i class="bi bi-file-earmark-arrow-up"></i> Choose File';
            }
        });
    }
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('use-question')) {
        const question = e.target.getAttribute('data-question');
        const questionTextarea = document.querySelector('textarea[name="question"]');
        if (!questionTextarea) {
            return;
        }
        const currentValue = questionTextarea.value.trim();
        questionTextarea.value = currentValue ? currentValue + '\n\n' + question : question;
        const questionCard = e.target.closest('.card');
        if (questionCard) {
            questionCard.style.opacity = '0.6';
            questionCard.style.borderLeft = '4px solid #28a745';
            e.target.disabled = true;
            e.target.innerHTML = '<i class="bi bi-check-circle"></i> Added';
            e.target.classList.remove('btn-outline-primary');
            e.target.classList.add('btn-success');
        }
        questionTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        questionTextarea.focus();
        questionTextarea.setSelectionRange(questionTextarea.value.length, questionTextarea.value.length);
    }
});

function generateQuestionsFromText(text, button) {
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
    fetch('{{ url_for("activities.generate_questions_route") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        handleGeneratedQuestions(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Generation failed, please try again');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-robot"></i> Generate Questions';
    });
}

function generateQuestionsFromFile(file, button) {
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing file...';
    const formData = new FormData();
    formData.append('file', file);
    fetch('{{ url_for("activities.generate_questions_route") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        handleGeneratedQuestions(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('File processing failed, please try again');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-robot"></i> Generate Questions from File';
    });
}

function handleGeneratedQuestions(data) {
        if (data.success) {
            const questionsList = document.getElementById('questions-list');
        if (!questionsList) {
            return;
        }
            questionsList.innerHTML = '';
        data.questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'card mb-2';
                questionDiv.innerHTML = `
                    <div class="card-body">
                        <p class="card-text">${question}</p>
                        <button class="btn btn-sm btn-outline-primary use-question" data-question="${question}">
                            Use this question
                        </button>
                    </div>
                `;
                questionsList.appendChild(questionDiv);
            });
            document.getElementById('generated-questions').style.display = 'block';
        document.getElementById('generated-questions').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        } else {
            alert('Generation failed: ' + data.message);
        }
}
</script>

<style>
.custom-file-upload {
    display: flex;
    align-items: center;
    gap: 10px;
}

.custom-file-upload .btn {
    white-space: nowrap;
}

#file-upload-status {
    font-size: 0.9em;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#file-upload-status.text-success {
    font-weight: 500;
}

/* Add scrollbar to duration dropdown menus */
#duration-hours-menu,
#duration-minutes-menu,
#duration-seconds-menu {
    max-height: 250px;
    overflow-y: auto;
    overflow-x: hidden;
}

/* Custom scrollbar styling for better appearance */
#duration-hours-menu::-webkit-scrollbar,
#duration-minutes-menu::-webkit-scrollbar,
#duration-seconds-menu::-webkit-scrollbar {
    width: 8px;
}

#duration-hours-menu::-webkit-scrollbar-track,
#duration-minutes-menu::-webkit-scrollbar-track,
#duration-seconds-menu::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#duration-hours-menu::-webkit-scrollbar-thumb,
#duration-minutes-menu::-webkit-scrollbar-thumb,
#duration-seconds-menu::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#duration-hours-menu::-webkit-scrollbar-thumb:hover,
#duration-minutes-menu::-webkit-scrollbar-thumb:hover,
#duration-seconds-menu::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}
