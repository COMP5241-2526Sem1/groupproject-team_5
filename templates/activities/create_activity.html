{% extends "base.html" %}

{% block title %}Create Activity - {{ course.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-plus-circle"></i> Create Activity in {{ course.name }}</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control") }}
                        {% if form.title.errors %}
                            <div class="text-danger">
                                {% for error in form.title.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.type.label(class="form-label") }}
                        {{ form.type(class="form-select") }}
                        {% if form.type.errors %}
                            <div class="text-danger">
                                {% for error in form.type.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="quiz-fields" style="display: none;">
                        <label class="form-label">Quiz Type</label>
                        <select id="quiz-type" class="form-select" name="quiz_type">
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="fill_blank">Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.question.label(class="form-label") }}
                        {{ form.question(class="form-control", rows="4") }}
                        {% if form.question.errors %}
                            <div class="text-danger">
                                {% for error in form.question.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="options-field" style="display: none;">
                        <label class="form-label">Options</label>
                        {{ form.options(id="options-hidden") }}
                        <div id="options-list" class="d-flex flex-column gap-2"></div>
                        <button type="button" id="add-option" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="bi bi-plus"></i> Add option
                        </button>
                        <div class="form-text">Enter one option per line. At least two options are required.</div>
                        {% if form.options.errors %}
                            <div class="text-danger">
                                {% for error in form.options.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="correct-answer-field" style="display: none;">
                        <label class="form-label">Correct Answer</label>
                        <select id="correct-answer-select" class="form-select" style="display: none;"></select>
                        <input type="text" id="correct-answer-text" class="form-control" style="display: none;" placeholder="Enter correct answer">
                        <input type="hidden" id="correct-answer-hidden" name="correct_answer">
                        <div class="form-text" id="correct-answer-hint"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity Duration</label>
                        <div class="row g-2">
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" id="duration-hours" class="form-control" value="0" aria-label="Hours">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Hours
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-hours-menu">
                                        {% for i in range(0, 13) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="hours" data-value="{{ i }}">{{ i }} hour{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" max="59" id="duration-minutes" class="form-control" value="5" aria-label="Minutes">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Minutes
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-minutes-menu">
                                        {% for i in range(0, 60) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="minutes" data-value="{{ i }}">{{ i }} min{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="input-group">
                                    <input type="number" min="0" max="59" id="duration-seconds" class="form-control" value="0" aria-label="Seconds">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        Seconds
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="duration-seconds-menu">
                                        {% for i in range(0, 60) %}
                                        <li><a class="dropdown-item duration-select-option" data-target="seconds" data-value="{{ i }}">{{ i }} sec{% if i != 1 %}s{% endif %}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="duration-hidden" name="duration_minutes" value="5">
                        <div class="form-text mt-2">Specify how long the activity remains open. Set hours, minutes, and seconds, or choose from the dropdown menus.</div>
                        {% if form.duration_minutes.errors %}
                            <div class="text-danger">
                                {% for error in form.duration_minutes.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('courses.course_detail', course_id=course.id) }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-robot"></i> AI-Assisted Question Generation</h5>
            </div>
            <div class="card-body">
                <!-- Tab navigation -->
                <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-panel" type="button" role="tab">
                            <i class="bi bi-file-text"></i> Text Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-panel" type="button" role="tab">
                            <i class="bi bi-file-earmark-arrow-up"></i> File Upload
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content mt-3" id="aiTabContent">
                    <!-- Text input tab -->
                    <div class="tab-pane fade show active" id="text-panel" role="tabpanel">
                <div class="mb-3">
                    <label for="ai-text" class="form-label">Paste Teaching Text</label>
                    <textarea id="ai-text" class="form-control" rows="4" placeholder="Paste your teaching text here, and AI will generate related questions..."></textarea>
                </div>
                        <button id="generate-questions-text" class="btn btn-outline-primary">
                    <i class="bi bi-robot"></i> Generate Questions
                </button>
                    </div>
                    
                    <!-- File upload tab -->
                    <div class="tab-pane fade" id="file-panel" role="tabpanel">
                        <div class="mb-3">
                            <label for="ai-file" class="form-label">Upload Document</label>
                            <div class="custom-file-upload">
                                <input type="file" id="ai-file" class="d-none" accept=".pdf,.docx,.pptx" />
                                <button type="button" class="btn btn-outline-secondary" id="file-upload-btn">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Choose File
                                </button>
                                <span id="file-upload-status" class="ms-2 text-muted">No file selected</span>
                            </div>
                            <div class="form-text mt-2">
                                <i class="bi bi-info-circle"></i> Supported formats: PDF (.pdf), Word Document (.docx), PowerPoint (.pptx). Maximum size: 10MB
                            </div>
                        </div>
                        <button id="generate-questions-file" class="btn btn-outline-primary">
                            <i class="bi bi-robot"></i> Generate Questions from File
                        </button>
                    </div>
                </div>
                
                <div id="generated-questions" class="mt-3" style="display: none;">
                    <h6>Generated Questions:</h6>
                    <div id="questions-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formEl = document.querySelector('form');
    const typeSelect = document.getElementById('type');
    const optionsField = document.getElementById('options-field');
    const optionsHidden = document.getElementById('options-hidden');
    const optionsList = document.getElementById('options-list');
    const addOptionBtn = document.getElementById('add-option');
    const quizFields = document.getElementById('quiz-fields');
    const quizTypeSelect = document.getElementById('quiz-type');
    const correctAnswerField = document.getElementById('correct-answer-field');
    const correctAnswerSelect = document.getElementById('correct-answer-select');
    const correctAnswerText = document.getElementById('correct-answer-text');
    const correctAnswerHidden = document.getElementById('correct-answer-hidden');
    const correctAnswerHint = document.getElementById('correct-answer-hint');
    const durationHidden = document.getElementById('duration-hidden');
    const durationHoursInput = document.getElementById('duration-hours');
    const durationMinutesInput = document.getElementById('duration-minutes');
    const durationSecondsInput = document.getElementById('duration-seconds');
    
    // Debug: 检查隐藏字段的属性
    if (durationHidden) {
        console.log('[Duration Debug] Hidden field element:', durationHidden);
        console.log('[Duration Debug] Hidden field name:', durationHidden.name);
        console.log('[Duration Debug] Hidden field id:', durationHidden.id);
        console.log('[Duration Debug] Hidden field initial value:', durationHidden.value);
    } else {
        console.error('[Duration Debug] duration-hidden element not found!');
    }
    
    const generateTextBtn = document.getElementById('generate-questions-text');
    const generateFileBtn = document.getElementById('generate-questions-file');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const fileInput = document.getElementById('ai-file');
    const fileStatus = document.getElementById('file-upload-status');

    function createOptionRow(value = '') {
        const row = document.createElement('div');
        row.className = 'input-group option-row';

        const label = document.createElement('span');
        label.className = 'input-group-text option-label';
        row.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control option-input';
        input.placeholder = 'Enter option';
        input.value = value;
        row.appendChild(input);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-outline-danger remove-option';
        removeBtn.innerHTML = '<i class="bi bi-dash"></i>';
        row.appendChild(removeBtn);

        removeBtn.addEventListener('click', function() {
            const rows = optionsList.querySelectorAll('.option-row');
            if (rows.length <= 1) {
                input.value = '';
                return;
            }
            row.remove();
            refreshOptionLabels();
            syncCorrectAnswerOptions();
        });

        input.addEventListener('input', syncCorrectAnswerOptions);
        return row;
    }

    function refreshOptionLabels() {
        const rows = optionsList.querySelectorAll('.option-row');
        rows.forEach((row, index) => {
            const label = row.querySelector('.option-label');
            label.textContent = String.fromCharCode(65 + index);
        });
    }

    function ensureOptionRows(min = 1) {
        let rows = optionsList.querySelectorAll('.option-row').length;
        while (rows < min) {
            optionsList.appendChild(createOptionRow());
            rows++;
        }
        refreshOptionLabels();
        syncCorrectAnswerOptions();
    }

    function getCurrentOptions() {
        const values = [];
        optionsList.querySelectorAll('.option-input').forEach(input => {
            const val = input.value.trim();
            if (val) {
                values.push(val);
            }
        });
        return values;
    }

    function showOptionsField(show) {
        optionsField.style.display = show ? 'block' : 'none';
    }

    function showCorrectAnswerSelect(show) {
        correctAnswerField.style.display = show ? 'block' : 'none';
        correctAnswerSelect.style.display = show ? 'block' : 'none';
        correctAnswerText.style.display = 'none';
        correctAnswerHint.textContent = show ? 'Select the correct answer from the options above.' : '';
    }

    function showCorrectAnswerText(show, placeholder = 'Enter correct answer') {
        correctAnswerField.style.display = show ? 'block' : 'none';
        correctAnswerSelect.style.display = 'none';
        correctAnswerText.style.display = show ? 'block' : 'none';
        correctAnswerText.placeholder = placeholder;
        correctAnswerHint.textContent = show ? 'Type the exact correct answer.' : '';
    }

    function syncCorrectAnswerOptions() {
        if (typeSelect.value !== 'quiz') {
            return;
        }
        const quizType = quizTypeSelect.value;
        if (quizType === 'multiple_choice') {
            const options = getCurrentOptions();
            correctAnswerSelect.innerHTML = '<option value="">Select correct answer</option>';
            options.forEach(option => {
                const optEl = document.createElement('option');
                optEl.value = option;
                optEl.textContent = option;
                correctAnswerSelect.appendChild(optEl);
            });
            if (options.includes(correctAnswerHidden.value)) {
                correctAnswerSelect.value = correctAnswerHidden.value;
            } else {
                correctAnswerSelect.value = '';
                correctAnswerHidden.value = '';
            }
        } else if (quizType === 'true_false') {
            correctAnswerSelect.innerHTML = '<option value="True">True</option><option value="False">False</option>';
            if (['True', 'False'].includes(correctAnswerHidden.value)) {
                correctAnswerSelect.value = correctAnswerHidden.value;
            } else {
                correctAnswerSelect.value = 'True';
                correctAnswerHidden.value = 'True';
            }
        }
    }

    function clampInputValue(input, min, max) {
        let value = parseInt(input.value, 10);
        if (isNaN(value) || value < min) {
            value = min;
        }
        if (typeof max === 'number' && value > max) {
            value = max;
        }
        input.value = value;
    }

    function initializeDurationFields() {
        if (!durationHidden) {
            return;
        }
        let storedMinutes = parseInt(durationHidden.value, 10);
        if (isNaN(storedMinutes) || storedMinutes < 1) {
            storedMinutes = 5;
        }
        const totalSeconds = storedMinutes * 60;
        if (durationHoursInput) {
            durationHoursInput.value = Math.floor(totalSeconds / 3600);
        }
        if (durationMinutesInput) {
            durationMinutesInput.value = Math.floor((totalSeconds % 3600) / 60);
        }
        if (durationSecondsInput) {
            durationSecondsInput.value = totalSeconds % 60;
        }
    }

    function handleTypeChange() {
        const type = typeSelect.value;
        if (type === 'poll') {
            quizFields.style.display = 'none';
            showOptionsField(true);
            showCorrectAnswerSelect(false);
            ensureOptionRows(1);
        } else if (type === 'quiz') {
            quizFields.style.display = 'block';
            handleQuizTypeChange();
        } else {
    quizFields.style.display = 'none';
            showOptionsField(false);
            showCorrectAnswerSelect(false);
        }
    }

    function handleQuizTypeChange() {
        const quizType = quizTypeSelect.value;
        if (quizType === 'multiple_choice') {
            showOptionsField(true);
            ensureOptionRows(1);
            showCorrectAnswerSelect(true);
            syncCorrectAnswerOptions();
        } else if (quizType === 'true_false') {
            showOptionsField(false);
            showCorrectAnswerSelect(true);
            syncCorrectAnswerOptions();
        } else {
            showOptionsField(false);
            showCorrectAnswerText(true, 'Enter the correct answer');
        }
    }

    if (addOptionBtn) {
        addOptionBtn.addEventListener('click', function() {
            optionsList.appendChild(createOptionRow());
            refreshOptionLabels();
            syncCorrectAnswerOptions();
        });
    }

    if (correctAnswerSelect) {
        correctAnswerSelect.addEventListener('change', function() {
            correctAnswerHidden.value = this.value;
        });
    }

    if (correctAnswerText) {
        correctAnswerText.addEventListener('input', function() {
            correctAnswerHidden.value = this.value.trim();
        });
    }

    console.log('[Duration Debug] Form element found:', formEl !== null);
    console.log('[Duration Debug] Duration fields exist:', {
        hidden: durationHidden !== null,
        hours: durationHoursInput !== null,
        minutes: durationMinutesInput !== null,
        seconds: durationSecondsInput !== null
    });

    if (formEl) {
        console.log('[Duration Debug] Adding submit event listener to form');
        formEl.addEventListener('submit', function(event) {
            console.log('[Duration Debug] FORM SUBMITTED! Event triggered');
            
            // IMPORTANT: Set duration value FIRST before any validation
            if (durationHidden && durationHoursInput && durationMinutesInput && durationSecondsInput) {
                console.log('[Duration Debug] All duration fields present, calculating...');
                clampInputValue(durationHoursInput, 0, null);
                clampInputValue(durationMinutesInput, 0, 59);
                clampInputValue(durationSecondsInput, 0, 59);
                const hours = parseInt(durationHoursInput.value, 10) || 0;
                const minutesPart = parseInt(durationMinutesInput.value, 10) || 0;
                const secondsPart = parseInt(durationSecondsInput.value, 10) || 0;
                const totalSeconds = hours * 3600 + minutesPart * 60 + secondsPart;
                
                console.log('[Duration Debug] Hours:', hours);
                console.log('[Duration Debug] Minutes:', minutesPart);
                console.log('[Duration Debug] Seconds:', secondsPart);
                console.log('[Duration Debug] Total seconds:', totalSeconds);
                
                const totalMinutes = Math.max(1, Math.ceil(totalSeconds / 60));
                
                console.log('[Duration Debug] Total minutes (calculated):', totalMinutes);
                console.log('[Duration Debug] Setting durationHidden.value to:', totalMinutes);
                
                durationHidden.value = totalMinutes;
                
                // Verify the value was set
                console.log('[Duration Debug] After setting - durationHidden.value:', durationHidden.value);
                console.log('[Duration Debug] After setting - durationHidden.name:', durationHidden.name);
                
                // Now validate
                if (totalSeconds <= 0) {
                    event.preventDefault();
                    alert('Please set a duration greater than zero.');
                    return;
                }
            }

            const type = typeSelect.value;
            const quizType = quizTypeSelect.value;
            let options = [];

            if (optionsField.style.display !== 'none') {
                options = getCurrentOptions();
                if (options.length < 2) {
                    event.preventDefault();
                    alert('Please enter at least two options.');
                    return;
                }
                optionsHidden.value = options.join('\n');
            } else {
                optionsHidden.value = '';
            }

            if (type === 'quiz') {
                if (quizType === 'multiple_choice') {
                    if (!correctAnswerSelect.value) {
                        event.preventDefault();
                        alert('Please select the correct answer.');
                        return;
                    }
                    correctAnswerHidden.value = correctAnswerSelect.value;
                } else if (quizType === 'true_false') {
                    correctAnswerHidden.value = correctAnswerSelect.value || 'True';
                } else {
                    const val = correctAnswerText.value.trim();
                    if (!val) {
                        event.preventDefault();
                        alert('Please enter the correct answer.');
                        return;
                    }
                    correctAnswerHidden.value = val;
                }
            } else {
                correctAnswerHidden.value = '';
            }
        });
    }

    const initialOptions = optionsHidden.value
        ? optionsHidden.value.split('\n').map(opt => opt.trim()).filter(opt => opt)
        : [];
    if (initialOptions.length) {
        initialOptions.forEach(opt => optionsList.appendChild(createOptionRow(opt)));
    } else {
        ensureOptionRows(1);
    }
    refreshOptionLabels();
    syncCorrectAnswerOptions();

    if (typeSelect) {
        handleTypeChange();
        typeSelect.addEventListener('change', handleTypeChange);
    }
    if (quizTypeSelect) {
        quizTypeSelect.addEventListener('change', handleQuizTypeChange);
    }

    if (durationHoursInput) {
        durationHoursInput.addEventListener('input', function() {
            clampInputValue(durationHoursInput, 0, null);
        });
    }
    if (durationMinutesInput) {
        durationMinutesInput.addEventListener('input', function() {
            clampInputValue(durationMinutesInput, 0, 59);
        });
    }
    if (durationSecondsInput) {
        durationSecondsInput.addEventListener('input', function() {
            clampInputValue(durationSecondsInput, 0, 59);
        });
    }

    document.querySelectorAll('.duration-select-option').forEach(item => {
        item.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            const value = parseInt(this.getAttribute('data-value'), 10) || 0;
            console.log('[Duration Debug] Dropdown clicked - Target:', target, 'Value:', value);
            
            if (target === 'hours' && durationHoursInput) {
                durationHoursInput.value = value;
                console.log('[Duration Debug] Hours input updated to:', durationHoursInput.value);
            } else if (target === 'minutes' && durationMinutesInput) {
                durationMinutesInput.value = value;
                console.log('[Duration Debug] Minutes input updated to:', durationMinutesInput.value);
            } else if (target === 'seconds' && durationSecondsInput) {
                durationSecondsInput.value = value;
                console.log('[Duration Debug] Seconds input updated to:', durationSecondsInput.value);
            }
            
            // Also log current state of all inputs
            console.log('[Duration Debug] Current state - H:', durationHoursInput?.value, 'M:', durationMinutesInput?.value, 'S:', durationSecondsInput?.value);
        });
    });

    initializeDurationFields();

    if (generateTextBtn) {
        generateTextBtn.addEventListener('click', function() {
            const textArea = document.getElementById('ai-text');
            const text = textArea ? textArea.value.trim() : '';
    if (!text) {
        alert('Please enter teaching text');
        return;
    }
            generateQuestionsFromText(text, this);
        });
    }

    if (generateFileBtn) {
        generateFileBtn.addEventListener('click', function() {
            const file = fileInput ? fileInput.files[0] : null;
            if (!file) {
                alert('Please select a file');
                return;
            }
            const allowedTypes = ['.pdf', '.docx', '.pptx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension)) {
                alert('Please upload a PDF, Word document, or PowerPoint presentation');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }
            generateQuestionsFromFile(file, this);
        });
    }

    if (fileUploadBtn && fileInput && fileStatus) {
        fileUploadBtn.addEventListener('click', function() {
            fileInput.click();
        });
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                const displayName = fileName.length > 30 ? fileName.substring(0, 27) + '...' : fileName;
                fileStatus.textContent = displayName;
                fileStatus.classList.remove('text-muted');
                fileStatus.classList.add('text-success');
                fileUploadBtn.classList.remove('btn-outline-secondary');
                fileUploadBtn.classList.add('btn-outline-success');
                fileUploadBtn.innerHTML = '<i class="bi bi-file-earmark-check"></i> File Selected';
            } else {
                fileStatus.textContent = 'No file selected';
                fileStatus.classList.remove('text-success');
                fileStatus.classList.add('text-muted');
                fileUploadBtn.classList.remove('btn-outline-success');
                fileUploadBtn.classList.add('btn-outline-secondary');
                fileUploadBtn.innerHTML = '<i class="bi bi-file-earmark-arrow-up"></i> Choose File';
            }
        });
    }
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('use-question')) {
        const question = e.target.getAttribute('data-question');
        const questionTextarea = document.querySelector('textarea[name="question"]');
        if (!questionTextarea) {
            return;
        }
        const currentValue = questionTextarea.value.trim();
        questionTextarea.value = currentValue ? currentValue + '\n\n' + question : question;
        const questionCard = e.target.closest('.card');
        if (questionCard) {
            questionCard.style.opacity = '0.6';
            questionCard.style.borderLeft = '4px solid #28a745';
            e.target.disabled = true;
            e.target.innerHTML = '<i class="bi bi-check-circle"></i> Added';
            e.target.classList.remove('btn-outline-primary');
            e.target.classList.add('btn-success');
        }
        questionTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        questionTextarea.focus();
        questionTextarea.setSelectionRange(questionTextarea.value.length, questionTextarea.value.length);
    }
});

function generateQuestionsFromText(text, button) {
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
    fetch('{{ url_for("activities.generate_questions_route") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        handleGeneratedQuestions(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Generation failed, please try again');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-robot"></i> Generate Questions';
    });
}

function generateQuestionsFromFile(file, button) {
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing file...';
    const formData = new FormData();
    formData.append('file', file);
    fetch('{{ url_for("activities.generate_questions_route") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        handleGeneratedQuestions(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('File processing failed, please try again');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-robot"></i> Generate Questions from File';
    });
}

function handleGeneratedQuestions(data) {
        if (data.success) {
            const questionsList = document.getElementById('questions-list');
        if (!questionsList) {
            return;
        }
            questionsList.innerHTML = '';
        data.questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'card mb-2';
                questionDiv.innerHTML = `
                    <div class="card-body">
                        <p class="card-text">${question}</p>
                        <button class="btn btn-sm btn-outline-primary use-question" data-question="${question}">
                            Use this question
                        </button>
                    </div>
                `;
                questionsList.appendChild(questionDiv);
            });
            document.getElementById('generated-questions').style.display = 'block';
        document.getElementById('generated-questions').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        } else {
            alert('Generation failed: ' + data.message);
        }
}
</script>

<style>
.custom-file-upload {
    display: flex;
    align-items: center;
    gap: 10px;
}

.custom-file-upload .btn {
    white-space: nowrap;
}

#file-upload-status {
    font-size: 0.9em;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#file-upload-status.text-success {
    font-weight: 500;
    }
</style>
{% endblock %}
