{% extends "base.html" %}

{% block title %}{{ activity.title }} - 结果分析{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-graph-up"></i> {{ activity.title }} - Results Analysis</h2>
        <p class="text-muted mb-0">{{ activity.course.name }} | {{ activity.type }}</p>
    </div>
    <div>
        <a href="{{ url_for('activities.activity_analytics', activity_id=activity.id) }}" class="btn btn-info me-2">
            <i class="bi bi-graph-up"></i> Analytics
        </a>
        <a href="{{ url_for('activities.export_activity_results', activity_id=activity.id) }}" class="btn btn-success me-2">
            <i class="bi bi-download"></i> Export CSV
        </a>
        <a href="{{ url_for('activities.activity_detail', activity_id=activity.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Activity
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        {% if results.type == 'poll' %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> Poll Results</h5>
            </div>
            <div class="card-body">
                {% if results.options %}
                    {% for option, count in results.options.items() %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>{{ option }}</span>
                            <span class="badge bg-primary">{{ count }} votes</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ (count / results.total_responses * 100) if results.total_responses > 0 else 0 }}%">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No poll data available</p>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">Total votes: {{ results.total_responses }}</small>
                </div>
            </div>
        </div>
        {% elif results.type == 'quiz' %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-check-circle"></i> Quiz Results</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <h4 class="text-success">{{ results.correct_count }}</h4>
                        <small class="text-muted">Correct Answers</small>
                    </div>
                    <div class="col-md-4">
                        <h4 class="text-primary">{{ results.total_responses }}</h4>
                        <small class="text-muted">Total Responses</small>
                    </div>
                    <div class="col-md-4">
                        <h4 class="text-warning">{{ "%.1f"|format(results.average_score * 100) }}%</h4>
                        <small class="text-muted">Average Score</small>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Answer</th>
                                <th>Result</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for response in results.responses %}
                            <tr>
                                <td>{{ response.student }}</td>
                                <td>{{ response.answer }}</td>
                                <td>
                                    {% if response.is_correct %}
                                        <span class="badge bg-success">Correct</span>
                                    {% else %}
                                        <span class="badge bg-danger">Incorrect</span>
                                    {% endif %}
                                </td>
                                <td>{{ response.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% elif results.type == 'word_cloud' %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-cloud"></i> Word Cloud</h5>
            </div>
            <div class="card-body">
                <div class="word-cloud">
                    {% for word, freq in results.word_frequency %}
                    <span class="badge bg-secondary me-1 mb-1" style="font-size: {{ (freq / results.word_frequency[0][1] * 20 + 12) }}px;">
                        {{ word }} ({{ freq }})
                    </span>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <small class="text-muted">Total responses: {{ results.total_responses }}</small>
                </div>
            </div>
        </div>
        {% elif results.type == 'memory_game' %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-controller"></i> Memory Game Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Submitted Sequence</th>
                                <th>Submitted At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for response in responses %}
                            <tr>
                                <td>{{ response.student.name }}</td>
                                <td>{{ response.answer }}</td>
                                <td>{{ response.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Total responses: {{ results.total_responses }}</small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-chat-text"></i> 简答题答案</h5>
            </div>
            <div class="card-body">
                {% if results.answers %}
                    {% for answer in results.answers %}
                    <div class="card mb-2">
                        <div class="card-body">
                            <p class="mb-0">{{ answer }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">暂无答案</p>
                {% endif %}
            </div>
        </div>
        
        {% if results.word_frequency %}
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-cloud"></i> 词频分析</h5>
            </div>
            <div class="card-body">
                <div class="word-cloud">
                    {% for word, freq in results.word_frequency %}
                    <span class="badge bg-secondary me-1 mb-1" style="font-size: {{ (freq / results.word_frequency[0][1] * 20 + 12) }}px;">
                        {{ word }} ({{ freq }})
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> 统计信息</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4>{{ results.total_responses }}</h4>
                        <small class="text-muted">总回答数</small>
                    </div>
                    <div class="col-6">
                        <h4>{{ activity.course.enrollments|length }}</h4>
                        <small class="text-muted">课程学生数</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h4>{{ "%.1f"|format((results.total_responses / activity.course.enrollments|length * 100) if activity.course.enrollments|length > 0 else 0) }}%</h4>
                    <small class="text-muted">参与率</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-people"></i> 参与学生</h5>
            </div>
            <div class="card-body">
                {% if responses %}
                    <div class="list-group list-group-flush">
                        {% for response in responses %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ response.student.name }}</strong>
                                {% if response.student.student_id %}
                                <br><small class="text-muted">{{ response.student.student_id }}</small>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ response.submitted_at.strftime('%H:%M') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">暂无参与学生</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
