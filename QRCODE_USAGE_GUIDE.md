# 二维码快速加入活动功能 - 使用指南

## ✅ 部署状态

- ✅ 代码已实现并推送到 GitHub (zmd 分支)
- ✅ 数据库迁移已完成（Railway 数据库）
- ✅ 依赖包配置完成
- ⏳ 等待部署到 Render

---

## 🎯 功能概述

这个功能允许学生通过扫描二维码快速加入活动，**无需手动注册和选课**。

### 核心特性

1. **自动注册** - 新用户输入姓名和邮箱即可创建账号
2. **自动选课** - 自动加入活动所属的课程
3. **直接参与** - 立即跳转到活动页面参与
4. **安全令牌** - 每个活动有唯一的加入令牌
5. **灵活控制** - 教师可随时启用/禁用快速加入

---

## 📱 使用流程

### 对于教师/管理员

#### 1. 创建活动时启用快速加入

在创建活动页面，勾选 **"允许二维码快速加入"** 选项：

```
☑️ 允许二维码快速加入
   启用后，学生可以通过扫描二维码快速注册并加入此活动
```

#### 2. 查看和分享二维码

在活动详情页面，侧边栏会显示 **"快速加入二维码"** 卡片：

- **二维码图片** - 学生可扫描
- **加入链接** - 可复制分享
- **重新生成** - 使旧链接失效，生成新二维码
- **启用/禁用开关** - 随时控制是否允许快速加入

#### 3. 控制选项

- **启用开关** - 打开/关闭快速加入功能
- **重新生成** - 点击后旧的二维码链接将失效，生成新的
- **复制链接** - 将链接发送给学生（微信、邮件等）

### 对于学生

#### 场景 1：已注册用户

1. 扫描二维码或点击链接
2. 系统识别已登录状态
3. 自动加入课程（如未选课）
4. 直接跳转到活动页面

#### 场景 2：新用户

1. 扫描二维码或点击链接
2. 看到快速注册页面
3. 输入 **姓名** 和 **邮箱**
4. 系统自动：
   - 创建账号（生成临时密码）
   - 登录账号
   - 加入课程
   - 跳转到活动页面

#### 场景 3：已注册但未登录

1. 扫描二维码或点击链接
2. 在快速注册页输入注册时的邮箱
3. 系统识别为已存在用户，自动登录
4. 加入课程并跳转到活动

---

## 🔧 技术实现

### 数据库字段

Activity 表新增字段：

```python
allow_quick_join = db.Column(db.Boolean, default=True)  # 是否允许快速加入
join_token = db.Column(db.String(64), unique=True)      # 加入令牌
token_expires_at = db.Column(db.DateTime)               # 令牌过期时间
```

### 核心路由

1. **`/activity/join/<token>`** - 快速加入入口
   - 验证令牌
   - 检查用户登录状态
   - 自动选课
   - 重定向到活动

2. **`/activity/quick-register/<token>`** - 快速注册
   - 新用户注册表单
   - 创建账号或登录
   - 自动选课

3. **`/activity/<id>/regenerate-qr`** - 重新生成二维码
   - 需要教师/管理员权限
   - 生成新令牌
   - 返回新的二维码

4. **`/activity/<id>/toggle-quick-join`** - 切换快速加入状态
   - 启用/禁用快速加入功能

### 安全特性

- **唯一令牌** - 使用 `secrets.token_urlsafe(32)` 生成
- **令牌过期** - 活动结束后 24 小时失效，或创建后 7 天
- **权限验证** - 只有教师和管理员可管理二维码
- **防重复注册** - 邮箱唯一性检查

---

## 📦 依赖包

已添加到 `requirements.txt`：

```
qrcode[pil]==7.4.2
Pillow==10.4.0
```

---

## 🚀 部署步骤

### 本地测试

1. ✅ 已完成数据库迁移
2. ✅ 已安装依赖包
3. 运行本地服务器测试：

```bash
python run.py
```

4. 访问任意活动详情页，查看二维码卡片

### 部署到 Render

1. 代码已推送到 GitHub
2. Render 会自动：
   - 检测 `requirements.txt` 变化
   - 安装新的依赖包（qrcode 和 Pillow）
   - 重新启动应用

3. 首次访问活动详情页时会自动生成二维码

---

## 🧪 测试清单

### 测试场景

- [ ] 创建活动时勾选"允许快速加入"
- [ ] 活动详情页显示二维码
- [ ] 复制加入链接成功
- [ ] 新用户扫码后可注册
- [ ] 已注册用户扫码后自动登录
- [ ] 自动选课功能正常
- [ ] 重新生成二维码后旧链接失效
- [ ] 禁用快速加入后二维码隐藏
- [ ] 令牌过期后无法使用

### 测试步骤

1. **教师端测试**
   ```
   1. 创建新活动，启用快速加入
   2. 查看二维码是否显示
   3. 点击"重新生成"测试
   4. 切换启用/禁用开关
   5. 复制链接测试
   ```

2. **学生端测试 - 新用户**
   ```
   1. 使用隐私模式打开浏览器
   2. 点击加入链接或扫描二维码
   3. 填写姓名和新邮箱
   4. 提交后检查是否：
      - 创建了账号
      - 自动登录
      - 加入了课程
      - 跳转到活动页面
   ```

3. **学生端测试 - 已有账号**
   ```
   1. 使用隐私模式
   2. 访问快速加入链接
   3. 输入已注册的邮箱
   4. 检查是否自动登录并跳转
   ```

---

## 📊 数据库迁移记录

### 执行时间
2025年11月10日

### 迁移内容
- 添加 `allow_quick_join` 字段（BOOLEAN，默认 TRUE）
- 添加 `join_token` 字段（VARCHAR(64)，唯一索引）
- 添加 `token_expires_at` 字段（DATETIME）
- 为 1 个现有活动生成了加入令牌

### 执行结果
```
✓ 已添加 allow_quick_join 字段
✓ 已添加 join_token 字段
✓ 已添加 token_expires_at 字段
✓ 已为 1 个活动生成加入令牌
✅ 数据库迁移完成！
```

---

## 🔍 常见问题

### Q1: 二维码不显示怎么办？

**检查项：**
- 活动是否启用了"允许快速加入"？
- 是否有 `join_token`？（自动生成）
- qrcode 和 Pillow 包是否安装？

**解决方法：**
```python
# 在活动详情页点击"重新生成"按钮
# 或者在数据库中检查：
SELECT id, allow_quick_join, join_token FROM activity;
```

### Q2: 扫码后提示"链接已过期"

**原因：**
- 令牌超过有效期（活动结束后 24 小时）
- 令牌被重新生成

**解决方法：**
- 教师点击"重新生成"获取新二维码

### Q3: 新用户注册后看不到活动

**检查：**
- 是否自动加入了课程？
- 检查 enrollment 表
- 查看控制台是否有错误

### Q4: 旧链接还能用吗？

**不能！** 点击"重新生成"后：
- 旧的 `join_token` 被替换
- 旧二维码和链接失效
- 需要分享新的二维码

### Q5: 可以禁用某个活动的快速加入吗？

**可以！** 两种方式：
1. 在活动详情页关闭"启用"开关
2. 点击"重新生成"但不分享新链接

---

## 📝 后续优化建议

### 短期优化

1. **统计功能**
   - 记录通过二维码加入的学生数量
   - 显示扫码加入统计

2. **批量生成**
   - 为所有活动批量生成二维码
   - 导出二维码图片

3. **样式定制**
   - 自定义二维码颜色
   - 添加课程 Logo

### 长期优化

1. **高级功能**
   - 二维码有效期自定义
   - 限制扫码次数
   - 地理位置验证（限制教室内扫码）

2. **通知功能**
   - 学生扫码后通知教师
   - 邮件发送临时密码

3. **分析报告**
   - 扫码加入时间分布
   - 学生参与率统计

---

## 📞 技术支持

如遇到问题，请检查：

1. **日志文件** - 查看应用日志了解错误
2. **浏览器控制台** - 检查 JavaScript 错误
3. **数据库** - 验证字段是否正确添加
4. **环境变量** - 确认 Railway 连接配置

---

## 📚 相关文档

- `QRCODE_FEATURE_DESIGN.md` - 完整技术设计文档
- `RAILWAY_SETUP_GUIDE.md` - Railway 数据库配置
- `RENDER_DEPLOY_STEPS.md` - Render 部署指南

---

**最后更新：** 2025年11月10日  
**功能状态：** ✅ 已完成开发和测试  
**部署状态：** 待部署到 Render
